name: CD

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            LOG_FILE="/home/lisich/Desktop/deploy.log"
            COMPOSE_FILE="~/OIS_Csharp-example/docker-compose.yml"

            echo "=== DOCKER COMPOSE DEPLOYMENT STARTED ===" > $LOG_FILE

            # Log in to GitHub Container Registry
            echo "ðŸ”‘ Logging in to GHCR..." | tee -a $LOG_FILE
            echo "${{ secrets.TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin >> $LOG_FILE 2>&1

            # Pull latest images
            echo "ðŸ“¥ Pulling latest Docker images..." | tee -a $LOG_FILE
            docker compose -f $COMPOSE_FILE pull >> $LOG_FILE 2>&1

            # Stop old containers and remove
            echo "ðŸ›‘ Stopping and removing old containers..." | tee -a $LOG_FILE
            docker compose -f $COMPOSE_FILE down >> $LOG_FILE 2>&1

            # Start new containers
            echo "ðŸš€ Starting new containers..." | tee -a $LOG_FILE
            docker compose -f $COMPOSE_FILE up -d >> $LOG_FILE 2>&1

            # Check containers status
            echo "ðŸ“‹ Containers status:" | tee -a $LOG_FILE
            docker compose -f $COMPOSE_FILE ps >> $LOG_FILE 2>&1

            # Cleanup unused images
            echo "ðŸ§¹ Cleaning up unused Docker images..." | tee -a $LOG_FILE
            docker image prune -f >> $LOG_FILE 2>&1

            echo "ðŸŽ‰ DOCKER COMPOSE DEPLOYMENT COMPLETED $(date)" | tee -a $LOG_FILE
