name: CD

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            LOG_FILE="/home/lisich/Desktop/deploy.log"
            APP_DIR="/home/lisich/Desktop/OIS_Csharp-example"
            COMPOSE_FILE="/home/lisich/Desktop/OIS_Csharp-example/docker-compose.yml"

            echo "=== DOCKER COMPOSE DEPLOYMENT STARTED ===" > $LOG_FILE
            echo "Time: $(date)" >> $LOG_FILE

            # Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GHCR
            echo "ðŸ”‘ Logging in to GHCR..." | tee -a $LOG_FILE
            echo "${{ secrets.TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin >> $LOG_FILE 2>&1

            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
            cd $APP_DIR

            # Pull latest images
            echo "ðŸ“¥ Pulling latest Docker images..." | tee -a $LOG_FILE
            docker compose -f $COMPOSE_FILE pull --progress=plain >> $LOG_FILE 2>&1

            # Stop old containers and remove
            echo "ðŸ›‘ Stopping and removing old containers..." | tee -a $LOG_FILE
            docker compose -f $COMPOSE_FILE down >> $LOG_FILE 2>&1

            # Kill processes that may still occupy ports
            echo "ðŸ”ª Killing processes on ports 5432 and 8181 (if any)..." | tee -a $LOG_FILE
            sudo kill -9 $(sudo lsof -t -i:5432) 2>/dev/null || true
            sudo kill -9 $(sudo lsof -t -i:8181) 2>/dev/null || true

            # Remove old DB volume
            echo "ðŸ§¨ Removing old DB volume..." | tee -a $LOG_FILE
            docker volume rm ois_csharp-example_db-data 2>/dev/null || true

            # Start new containers
            echo "ðŸš€ Starting new containers..." | tee -a $LOG_FILE
            docker compose -f $COMPOSE_FILE up -d >> $LOG_FILE 2>&1


            # Check containers status
            echo "ðŸ“‹ Containers status:" | tee -a $LOG_FILE
            docker compose -f $COMPOSE_FILE ps >> $LOG_FILE 2>&1

            # Cleanup unused images
            echo "ðŸ§¹ Cleaning up unused Docker images..." | tee -a $LOG_FILE
            docker image prune -f >> $LOG_FILE 2>&1

            echo "ðŸŽ‰ DOCKER COMPOSE DEPLOYMENT COMPLETED $(date)" | tee -a $LOG_FILE
