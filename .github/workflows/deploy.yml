name: CD

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            LOG_FILE="/home/lisich/Desktop/deploy.log"
            APP_DIR="/home/lisich/OIS_Csharp-example"   # Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ðº Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ
            COMPOSE_FILE="$APP_DIR/docker-compose.yml"

            echo "=== DOCKER COMPOSE DEPLOYMENT STARTED ===" > $LOG_FILE
            echo "Time: $(date)" >> $LOG_FILE

            cd $APP_DIR

            # Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GHCR
            echo "ðŸ”‘ Logging in to GitHub Container Registry..." | tee -a $LOG_FILE
            if ! echo "${{ secrets.TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin >> $LOG_FILE 2>&1; then
              echo "âŒ GHCR login failed" | tee -a $LOG_FILE
              exit 1
            fi

            # ÐŸÑƒÐ»Ð»Ð¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·
            echo "ðŸ“¥ Pulling latest Docker images..." | tee -a $LOG_FILE
            if ! docker compose -f $COMPOSE_FILE pull >> $LOG_FILE 2>&1; then
              echo "âŒ Docker compose pull failed" | tee -a $LOG_FILE
              exit 1
            fi

            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
            echo "ðŸ›‘ Stopping and removing old containers..." | tee -a $LOG_FILE
            docker compose -f $COMPOSE_FILE down >> $LOG_FILE 2>&1 || true

            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÑÑ‚ÐµÐº
            echo "ðŸš€ Starting new containers..." | tee -a $LOG_FILE
            if ! docker compose -f $COMPOSE_FILE up -d >> $LOG_FILE 2>&1; then
              echo "âŒ Docker compose up failed" | tee -a $LOG_FILE
              exit 1
            fi

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
            echo "ðŸ“‹ Containers status:" | tee -a $LOG_FILE
            docker compose -f $COMPOSE_FILE ps >> $LOG_FILE 2>&1

            # Ð§Ð¸ÑÑ‚Ð¸Ð¼ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
            echo "ðŸ§¹ Cleaning up unused Docker images..." | tee -a $LOG_FILE
            docker image prune -f >> $LOG_FILE 2>&1

            echo "ðŸŽ‰ DOCKER COMPOSE DEPLOYMENT COMPLETED $(date)" | tee -a $LOG_FILE
